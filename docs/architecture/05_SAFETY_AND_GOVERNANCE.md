# 05: Safety and Governance

Safety is the most critical principle for an autonomous agent with access to a user's operating system. This document outlines the policies and mechanisms to ensure the Talk2Windows agent operates safely, respects user privacy, and prevents unintended consequences.

## 1. Risk-Based Confirmation Policy

Actions are categorized into three risk levels, defined in the script metadata. The Agent Service will enforce a confirmation policy based on these levels before invoking the PowerShell Executor.

| `risk_level` | Description                                                                 | Confirmation Policy                                     | Examples                                                              |
|--------------|-----------------------------------------------------------------------------|---------------------------------------------------------|-----------------------------------------------------------------------|
| **`low`**    | Read-only operations or actions with trivial, easily reversible side effects. | **Execute Silently.** No confirmation required.         | `check-time`, `open-calculator`, `list-running-processes`, `close-program` |
| **`medium`** | Actions that modify the filesystem, install software, or change settings.   | **Single Confirmation.** The agent must ask for a simple "yes/no" confirmation. | `install-app`, `empty-recycle-bin`, `move-file`, `set-wallpaper`      |
| **`high`**   | Potentially destructive or irreversible actions.                            | **Passphrase + Confirmation.** The agent must ask for confirmation and require the user to speak a pre-configured passphrase. | `reboot-computer`, `delete-file`, `uninstall-app`, `edit-registry` (future) |

### Confirmation Flow

1.  **Planner -> Agent:** The Gemini Planner returns a function call for a tool.
2.  **Agent -> Metadata:** The Agent Service retrieves the `risk_level` from the tool's metadata.
3.  **Agent -> User (if needed):**
    - If `medium`: "I am about to empty the recycle bin. Shall I proceed?"
    - If `high`: "I am about to reboot the computer. Please confirm with your passphrase."
4.  **User -> Agent:** The user responds verbally.
5.  **Agent -> Executor:** Only upon receiving the correct confirmation does the agent execute the command. If confirmation is denied, the agent cancels the action and informs the user.

## 2. Secrets and Credential Management

The agent must never have direct access to passwords, API keys, or other secrets. All secrets will be managed through established, secure Windows mechanisms.

- **Technology:** We will use PowerShell's standard `Microsoft.PowerShell.SecretManagement` module combined with the `Microsoft.PowerShell.SecretStore` or a community-backed extension vault that uses the Windows Credential Manager.
- **Workflow:**
    1.  **Storage:** A user will store a secret (e.g., a GitHub API token) in the vault with a specific name (e.g., `GitHubApiToken`).
    2.  **Script Access:** A PowerShell script that needs this secret will use the `Get-Secret` cmdlet to retrieve it *at runtime*. The secret is injected directly into the script's process memory.
    3.  **Agent Ignorance:** The Agent Service and the Gemini model **never** see the secret's value. They only know the *name* of the secret (e.g., by passing `GitHubApiToken` as a parameter). The `run-script.ps1` executor handles the call, and the secret value is resolved and used entirely within the sandboxed PowerShell process.

## 3. Filesystem Safeguards

To prevent accidental data loss, especially with future "cleanup" or "organize" capabilities, the following safeguard will be implemented for any bulk-delete or bulk-move operation:

- **Quarantine Zone:** Instead of deleting files directly, the agent will move them to a temporary "quarantine" directory (e.g., `C:\Users\CurrentUser\.talk2windows\quarantine\<timestamp>`).
- **Undo Capability:** The agent will log the source and destination of the moved files, allowing it to offer an "undo" command that moves them back.
- **Timed Auto-Deletion:** Files in the quarantine zone will be automatically deleted after a configurable period (e.g., 7 days), giving the user ample time to notice and recover any mistakes.

## 4. Governance and Logging

- **Audit Trail:** All actions taken by the agent, including the user's request, the plan generated by Gemini, and the result of the execution, will be logged to a local file.
- **PII Redaction:** The logging mechanism will attempt to redact Personally Identifiable Information (PII) where possible, although perfect redaction is not guaranteed. Secrets will never be logged.
- **Budget Enforcement:** The agent will enforce strict timeouts on all script executions to prevent runaway processes. Future versions will include budgets for API calls to control costs.

By embedding these safety mechanisms at the core of the agent's architecture, we can build a powerful tool that users can trust.
